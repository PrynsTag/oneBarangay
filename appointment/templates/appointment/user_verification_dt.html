{% extends "layouts/base.html" %}
{% load poll_extras %}

{% load static %}

{% block title %}
    Barangay Admin - User Verification for Document Request
{% endblock %}

{% block stylesheets %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Data Table -->
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css"/>
    <link type="text/css" rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css"/>

    <link href="{% static "appointment/assets/css/user_verification_dt.css" %}" rel="stylesheet">
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between w-100 flex-wrap py-2">
        <div class="mb-3 mb-lg-0">
            <h1 class="h4">User Verification</h1>
            <p class="mb-0">List of User Information</p>
        </div>
    </div>

    <div id="jsGrid"></div>

{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            let user_data =

            {{ user_data | js }};

            let role = [
                {Name: "", Id: 0},
                {Name: "Resident", Id: 1},
                {Name: "Admin", Id: 2},
                {Name: "Worker", Id: 3},
                {Name: "Secretary", Id: 4}
            ];

            let citizenship = [
                {Name: "", Id: 0},
                {Name: "Single", Id: 1},
                {Name: "Married", Id: 2},
                {Name: "Widowed", Id: 3},
                {Name: "Separated", Id: 4},
                {Name: "Divorced", Id: 5},
            ]

            $("#jsGrid").jsGrid({
                height: "90%",
                width: "100%",

                filtering: true,
                editing: true,
                sorting: true,
                paging: true,
                autoload: false,

                pageSize: 15,
                pageButtonCount: 5,

                deleteConfirm: "Do you really want to delete the client?",

                data: user_data,

                controller: {
                    loadData: function (filter) {
                        console.log(filter);

                        $.ajax({
                            url: "{% url "appointment:user_filter" %}",
                            type: "POST",
                            data: {'data': JSON.stringify(filter)},
                            dataType: 'json',
                        }).done(function (result) {
                            console.log(result.data);
                        });
                    },
                },

                fields: [
                    {name: "First Name", type: "text", width: 100},
                    {name: "Middle Name", type: "text", width: 100},
                    {name: "Last Name", type: "text", width: 100},
                    {name: "Street", type: "text", width: 150},
                    {name: "Role", type: "select", items: role, valueField: "Id", textField: "Name"},
                    {name: "Civil Status", type: "select", items: citizenship, valueField: "Id", textField: "Name"},
                ],

                rowClick: function (args) {
                    let getData = args.item;
                    let keys = Object.keys(getData);
                    let text = {};

                    $.each(keys, function (idx, value) {
                        text[value] = getData[value];
                    });

                    Swal.fire({
                        title: 'Are you sure?',
                        text: "You want to select this user.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Swal.fire(
                                'Selected!',
                                'User successfully selected!',
                                'success'
                            ).then((result) => {
                                $.ajax({
                                    url: "{% url "appointment:user_selection_data" document_request_id %}",
                                    type: "POST",
                                    data: {'row_data': JSON.stringify(text)},
                                    dataType: 'json',
                                    success: function (result) {
                                        console.log("User selection success")
                                    },
                                    error: function (request) {
                                        console.log("Error. Please contact your dev.")
                                    }
                                }).done(function (data) {
                                    if (data.success) {
                                        window.location.href = data.url;
                                    }
                                });
                            })
                        }
                    });
                }
            });
        });
    </script>
{% endblock %}
